<div class="settings-container container-sm">
  <h1>User Settings</h1>

  @if (loading()) {
    <div class="loading-state">
      <mat-spinner></mat-spinner>
      <p>Loading settings...</p>
    </div>
  } @else {
    <!-- Profile Settings -->
    <mat-card class="settings-card">
      <mat-card-header>
        <mat-card-title>Profile</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="profileForm">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>First Name</mat-label>
            <input matInput formControlName="firstName" required />
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Last Name</mat-label>
            <input matInput formControlName="lastName" required />
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Email</mat-label>
            <input matInput type="email" formControlName="email" required />
          </mat-form-field>
        </form>
      </mat-card-content>
      <mat-card-actions>
        <button
          mat-raised-button
          color="primary"
          (click)="updateProfile()"
          [disabled]="!profileForm.valid || loading()"
        >
          Save Profile
        </button>
        <button mat-raised-button (click)="openChangePasswordDialog()">
          Change Password
        </button>
      </mat-card-actions>
    </mat-card>

    <!-- Reddit Settings -->
    <mat-card class="settings-card">
      <mat-card-header>
        <mat-card-title>Reddit Integration</mat-card-title>
        <mat-card-subtitle
          >Configure Reddit API credentials to enable Reddit
          feeds</mat-card-subtitle
        >
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="redditForm">
          <mat-checkbox formControlName="enabled" class="full-width">
            Enable Reddit Integration
          </mat-checkbox>

          @if (redditForm.get("enabled")?.value) {
            <div class="credentials-section">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Client ID</mat-label>
                <input matInput formControlName="clientId" required />
                @if (redditForm.get("clientId")?.hasError("server")) {
                  <mat-error>{{
                    redditForm.get("clientId")?.getError("server")
                  }}</mat-error>
                } @else if (
                  redditForm.get("clientId")?.touched &&
                  redditForm.get("clientId")?.hasError("required")
                ) {
                  <mat-error>Client ID is required</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Client Secret</mat-label>
                <input
                  matInput
                  [type]="
                    redditForm.get('clientSecret')?.value === '••••••••'
                      ? 'text'
                      : 'password'
                  "
                  formControlName="clientSecret"
                  required
                  [placeholder]="
                    redditForm.get('clientSecret')?.value === '••••••••'
                      ? 'Secret is set (enter new value to change)'
                      : ''
                  "
                />
                @if (redditForm.get("clientSecret")?.hasError("server")) {
                  <mat-error>{{
                    redditForm.get("clientSecret")?.getError("server")
                  }}</mat-error>
                } @else if (
                  redditForm.get("clientSecret")?.touched &&
                  redditForm.get("clientSecret")?.hasError("required")
                ) {
                  <mat-error>Client Secret is required</mat-error>
                } @else if (
                  redditForm.get("clientSecret")?.value === "••••••••"
                ) {
                  <mat-hint
                    >Leave unchanged to keep existing secret, or enter a new
                    value</mat-hint
                  >
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>User Agent</mat-label>
                <input matInput formControlName="userAgent" />
                @if (redditForm.get("userAgent")?.hasError("server")) {
                  <mat-error>{{
                    redditForm.get("userAgent")?.getError("server")
                  }}</mat-error>
                }
              </mat-form-field>

              <div class="help-text">
                <h4>How to get Reddit credentials:</h4>
                <ol>
                  <li>
                    Go to
                    <a href="https://www.reddit.com/prefs/apps" target="_blank"
                      >Reddit Apps</a
                    >
                  </li>
                  <li>Click "create another app..."</li>
                  <li>Select "script" as app type</li>
                  <li>Fill in name (e.g., "Yana")</li>
                  <li>Set redirect URI to http://localhost:8000</li>
                  <li>Click "create app"</li>
                  <li>Client ID: string under "personal use script"</li>
                  <li>Client Secret: string next to "secret"</li>
                </ol>
              </div>
            </div>
          }
        </form>
      </mat-card-content>
      <mat-card-actions>
        <button
          mat-raised-button
          color="primary"
          (click)="updateRedditSettings()"
          [disabled]="loading()"
        >
          Save Reddit Settings
        </button>
      </mat-card-actions>
    </mat-card>

    <!-- YouTube Settings -->
    <mat-card class="settings-card">
      <mat-card-header>
        <mat-card-title>YouTube Integration</mat-card-title>
        <mat-card-subtitle
          >Configure YouTube API key to enable YouTube channel
          feeds</mat-card-subtitle
        >
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="youtubeForm">
          <mat-checkbox formControlName="enabled" class="full-width">
            Enable YouTube Integration
          </mat-checkbox>

          @if (youtubeForm.get("enabled")?.value) {
            <div class="credentials-section">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>API Key</mat-label>
                <input
                  matInput
                  [type]="
                    youtubeForm.get('apiKey')?.value === '••••••••'
                      ? 'text'
                      : 'password'
                  "
                  formControlName="apiKey"
                  required
                  [placeholder]="
                    youtubeForm.get('apiKey')?.value === '••••••••'
                      ? 'API key is set (enter new value to change)'
                      : ''
                  "
                />
                @if (youtubeForm.get("apiKey")?.hasError("server")) {
                  <mat-error>{{
                    youtubeForm.get("apiKey")?.getError("server")
                  }}</mat-error>
                } @else if (
                  youtubeForm.get("apiKey")?.touched &&
                  youtubeForm.get("apiKey")?.hasError("required")
                ) {
                  <mat-error>API Key is required</mat-error>
                } @else if (youtubeForm.get("apiKey")?.value === "••••••••") {
                  <mat-hint
                    >Leave unchanged to keep existing key, or enter a new
                    value</mat-hint
                  >
                }
              </mat-form-field>

              <div class="help-text">
                <h4>How to get YouTube API key:</h4>
                <ol>
                  <li>
                    Go to
                    <a
                      href="https://console.cloud.google.com/apis/credentials"
                      target="_blank"
                      >Google Cloud Console</a
                    >
                  </li>
                  <li>Create a new project or select existing</li>
                  <li>Enable "YouTube Data API v3"</li>
                  <li>Create credentials → API Key</li>
                  <li>Copy the API key</li>
                </ol>
              </div>
            </div>
          }
        </form>
      </mat-card-content>
      <mat-card-actions>
        <button
          mat-raised-button
          color="primary"
          (click)="updateYouTubeSettings()"
          [disabled]="loading()"
        >
          Save YouTube Settings
        </button>
      </mat-card-actions>
    </mat-card>

    <!-- OpenAI Settings -->
    <mat-card class="settings-card">
      <mat-card-header>
        <mat-card-title>OpenAI Integration</mat-card-title>
        <mat-card-subtitle
          >Configure OpenAI API for AI-powered features (translation,
          summarization)</mat-card-subtitle
        >
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="openaiForm">
          <mat-checkbox formControlName="enabled" class="full-width">
            Enable OpenAI Integration
          </mat-checkbox>

          @if (openaiForm.get("enabled")?.value) {
            <div class="credentials-section">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>API URL</mat-label>
                <input matInput formControlName="apiUrl" required />
                @if (openaiForm.get("apiUrl")?.hasError("server")) {
                  <mat-error>{{
                    openaiForm.get("apiUrl")?.getError("server")
                  }}</mat-error>
                } @else if (
                  openaiForm.get("apiUrl")?.touched &&
                  openaiForm.get("apiUrl")?.hasError("required")
                ) {
                  <mat-error>API URL is required</mat-error>
                } @else {
                  <mat-hint
                    >For OpenAI use https://api.openai.com/v1, or use compatible
                    API (Ollama, LM Studio)</mat-hint
                  >
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>API Key</mat-label>
                <input
                  matInput
                  [type]="
                    openaiForm.get('apiKey')?.value === '••••••••'
                      ? 'text'
                      : 'password'
                  "
                  formControlName="apiKey"
                  required
                  [placeholder]="
                    openaiForm.get('apiKey')?.value === '••••••••'
                      ? 'API key is set (enter new value to change)'
                      : ''
                  "
                />
                @if (openaiForm.get("apiKey")?.hasError("server")) {
                  <mat-error>{{
                    openaiForm.get("apiKey")?.getError("server")
                  }}</mat-error>
                } @else if (
                  openaiForm.get("apiKey")?.touched &&
                  openaiForm.get("apiKey")?.hasError("required")
                ) {
                  <mat-error>API Key is required</mat-error>
                } @else if (openaiForm.get("apiKey")?.value === "••••••••") {
                  <mat-hint
                    >Leave unchanged to keep existing key, or enter a new
                    value</mat-hint
                  >
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Model</mat-label>
                <input matInput formControlName="model" />
                <mat-hint>e.g., gpt-4o-mini, gpt-4, gpt-3.5-turbo</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Temperature</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="temperature"
                  step="0.1"
                  min="0"
                  max="2"
                />
                <mat-hint>0.0-2.0 (lower = more deterministic)</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Max Tokens</mat-label>
                <input matInput type="number" formControlName="maxTokens" />
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Daily Request Limit</mat-label>
                <input matInput type="number" formControlName="dailyLimit" />
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Monthly Request Limit</mat-label>
                <input matInput type="number" formControlName="monthlyLimit" />
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Request Timeout (seconds)</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="requestTimeout"
                  min="10"
                  max="600"
                />
                <mat-hint
                  >Timeout for AI API requests (default: 120 seconds)</mat-hint
                >
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Max Retries</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="maxRetries"
                  min="1"
                  max="10"
                />
                <mat-hint>Maximum number of retry attempts on failure</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Retry Delay (seconds)</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="retryDelay"
                  min="1"
                  max="60"
                />
                <mat-hint
                  >Base delay between retries (exponential backoff)</mat-hint
                >
              </mat-form-field>

              <div class="help-text">
                <h4>How to get OpenAI API key:</h4>
                <ol>
                  <li>
                    Go to
                    <a
                      href="https://platform.openai.com/api-keys"
                      target="_blank"
                      >OpenAI API Keys</a
                    >
                  </li>
                  <li>Sign up or log in</li>
                  <li>Click "Create new secret key"</li>
                  <li>Copy the API key (starts with sk-)</li>
                  <li>Add billing information to your OpenAI account</li>
                </ol>
                <p>
                  <strong>Note:</strong> You can also use OpenAI-compatible APIs
                  like Ollama or LM Studio by changing the API URL.
                </p>
              </div>
            </div>
          }
        </form>
      </mat-card-content>
      <mat-card-actions>
        <button
          mat-raised-button
          color="primary"
          (click)="updateOpenAISettings()"
          [disabled]="loading()"
        >
          Save OpenAI Settings
        </button>
      </mat-card-actions>
    </mat-card>
  }
</div>
