---
description: Aggregator class development guidelines and best practices
globs: ["src/server/aggregators/**/*.ts"]
alwaysApply: false
---

# Aggregator Class Guidelines

## Core Rules

1. **Class properties only** - Use readonly properties for metadata. Use `""` for empty URLs.
2. **No empty lines between properties** - Keep all properties together.
3. **Always use identifier** - Use `feed.identifier` or `feedIdentifier` parameter, never `feed.url`.
4. **Override granular methods** - Override `extractContent()`, `shouldSkipArticle()`, `fetchArticleHtml()`, etc. Never override `aggregate()` or `processArticle()`.
5. **Call super when extending** - Preserve base behavior unless completely replacing.

```typescript
export class MyAggregator extends FullWebsiteAggregator {
  override readonly id = "my_aggregator";
  override readonly type: "managed" | "custom" | "social" = "managed";
  override readonly name = "My Site";
  override readonly url = "https://example.com/feed.xml";
  override readonly description = "Description";
  override readonly waitForSelector = ".content";
  override readonly selectorsToRemove = [".ad", "script"];

  override async fetchRssFeed(feedIdentifier: string): Promise<any> {
    return fetchFeed(feedIdentifier); // Use identifier, not this.feed.url
  }

  override shouldSkipArticle(article: RawArticle): [boolean, string | null] {
    if (article.title.includes("[SPONSORED]")) {
      return [true, "Skipping sponsored"];
    }
    return super.shouldSkipArticle(article);
  }
}
```

## Error Handling

Handle errors with fallbacks and logging:

```typescript
override extractContent(article: RawArticle): void {
  try {
    const $ = cheerio.load(article.html);
    const content = $(".article-body").first();
    if (content.length === 0) {
      this.logger.warn({ url: article.url }, "Selector not found");
      return; // Keep full HTML as fallback
    }
    article.html = content.html() || article.html;
  } catch (error) {
    this.logger.error({ error, url: article.url }, "Extraction failed");
    // Don't modify article.html - let fallback handle it
  }
}
```

Rules: Use `this.logger`, log warnings for expected failures, errors with context for unexpected, always provide fallback, never let exceptions propagate.

## Testing

Write tests for all overridden methods:

```typescript
import { describe, it, expect, beforeEach } from "vitest";
import { MyAggregator } from "../my_aggregator";
import type { RawArticle } from "../base/types";

describe("MyAggregator", () => {
  let aggregator: MyAggregator;
  let article: RawArticle;

  beforeEach(() => {
    aggregator = new MyAggregator();
    article = {
      url: "https://example.com/article",
      title: "Test",
      date: new Date(),
      html: "<p>Test</p>",
    };
  });

  it("should extract content", () => {
    article.html = '<div class="article-body"><p>Content</p></div>';
    aggregator.extractContent(article);
    expect(article.html).toContain("Content");
  });

  it("should skip sponsored articles", () => {
    article.title = "[SPONSORED] Test";
    const [shouldSkip, reason] = aggregator.shouldSkipArticle(article);
    expect(shouldSkip).toBe(true);
  });

  it("should handle errors gracefully", () => {
    article.html = "invalid html";
    expect(() => aggregator.extractContent(article)).not.toThrow();
  });
});
```

Coverage: All overridden methods, error paths, edge cases, options, identifier validation.

## Options

```typescript
override readonly options: OptionsSchema = {
  option_name: {
    type: "boolean" | "integer" | "string" | "select",
    label: "Label",
    helpText: "Description",
    default: value,
    min: 0,
    max: 100, // For integer
    choices: [["val", "Label"]], // For select
  },
};
```

Access: `this.getOption("option_name", default)`

## Example

```typescript
import * as cheerio from "cheerio";
import { FullWebsiteAggregator } from "./full_website";
import type { RawArticle } from "./base/types";

export class ExampleAggregator extends FullWebsiteAggregator {
  override readonly id = "example";
  override readonly type: "managed" | "custom" | "social" = "managed";
  override readonly name = "Example";
  override readonly url = "https://example.com/feed.xml";
  override readonly description = "Example aggregator";
  override readonly waitForSelector = ".content";
  override readonly selectorsToRemove = [".ad", "script"];
  override readonly options: OptionsSchema = {};

  override shouldSkipArticle(article: RawArticle): [boolean, string | null] {
    if (article.title.includes("[SPONSORED]")) {
      return [true, `Skipping sponsored: ${article.title}`];
    }
    return super.shouldSkipArticle(article);
  }

  override extractContent(article: RawArticle): void {
    try {
      const $ = cheerio.load(article.html);
      const content = $(".article-body").first();
      if (content.length === 0) {
        this.logger.warn({ url: article.url }, "Selector not found");
        return;
      }
      article.html = content.html() || article.html;
    } catch (error) {
      this.logger.error({ error, url: article.url }, "Extraction failed");
    }
  }
}
```
