#!/usr/bin/env sh

# Conventional Commits validation hook
# Validates commit messages against the Conventional Commits specification
# See: https://www.conventionalcommits.org/

commit_msg_file="$1"
commit_msg=$(cat "$commit_msg_file")

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Skip validation for merge commits, revert commits, and fixup/squash commits
if echo "$commit_msg" | grep -qE "^Merge |^Revert |^fixup!|^squash!"; then
  exit 0
fi

# Extract the first line (subject line)
subject_line=$(echo "$commit_msg" | head -n 1)

# Pattern for conventional commits:
# - type (required): feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert
# - optional scope in parentheses: (scope)
# - optional ! for breaking changes
# - colon and space: : 
# - description (required)
# - optional body and footer are allowed after the subject line

# Valid types
valid_types="feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"

# Pattern breakdown:
# ^ - start of line
# ($valid_types) - one of the valid types
# (!?) - optional exclamation mark for breaking changes
# (\([^)]+\))? - optional scope in parentheses
# !? - optional exclamation mark after scope (for breaking changes)
# :\s - colon followed by space (required)
# .+ - description (at least one character)
# $ - end of line

if ! echo "$subject_line" | grep -qE "^($valid_types)(!)?(\([^)]+\))?(!)?:\s.+$"; then
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "${RED}ğŸš¨ COMMIT MESSAGE VALIDATION FAILED${NC}"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "${RED}âŒ Your commit message does not follow the Conventional Commits format.${NC}"
  echo ""
  echo "${YELLOW}Required format:${NC}"
  echo "  <type>[optional scope]: <description>"
  echo ""
  echo "${YELLOW}Valid types:${NC}"
  echo "  feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
  echo ""
  echo "${YELLOW}Examples:${NC}"
  echo "  ${GREEN}feat(api): add user authentication endpoint${NC}"
  echo "  ${GREEN}fix(aggregators): handle missing RSS feed gracefully${NC}"
  echo "  ${GREEN}docs: update installation instructions${NC}"
  echo "  ${GREEN}refactor(core): extract feed service logic${NC}"
  echo "  ${GREEN}test(api): add tests for subscription endpoints${NC}"
  echo "  ${GREEN}chore: update dependencies${NC}"
  echo ""
  echo "${YELLOW}Breaking changes:${NC}"
  echo "  ${GREEN}feat(api)!: change authentication method${NC}"
  echo ""
  echo "${YELLOW}Your commit message:${NC}"
  echo "  ${RED}$subject_line${NC}"
  echo ""
  echo "${YELLOW}Common scopes (optional):${NC}"
  echo "  api, api_v1, core, aggregators, frontend, deps, ci"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "${RED}âš ï¸  COMMIT BLOCKED - Please fix your commit message and try again.${NC}"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  exit 1
fi

# Check for minimum description length (at least 3 characters after "type: ")
# Extract description by removing everything up to and including ": "
description=$(echo "$subject_line" | sed -E "s/^($valid_types)(!)?(\([^)]+\))?(!)?:[[:space:]]+//")
if [ -z "$description" ] || [ ${#description} -lt 3 ]; then
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "${RED}ğŸš¨ COMMIT MESSAGE VALIDATION FAILED${NC}"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "${RED}âŒ Commit message description is too short.${NC}"
  echo ""
  echo "${YELLOW}Your commit message:${NC}"
  echo "  ${RED}$subject_line${NC}"
  echo ""
  echo "${YELLOW}Please provide a more descriptive commit message (at least 3 characters).${NC}"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "${RED}âš ï¸  COMMIT BLOCKED - Please fix your commit message and try again.${NC}"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  exit 1
fi

# Check for maximum subject line length (72 characters recommended, but allow up to 100)
if [ ${#subject_line} -gt 100 ]; then
  echo ""
  echo "${YELLOW}âš ï¸  WARNING: Commit message subject line is longer than 100 characters.${NC}"
  echo "${YELLOW}   Consider keeping it under 72 characters for better readability.${NC}"
  echo ""
  echo "${YELLOW}Your commit message:${NC}"
  echo "  $subject_line"
  echo ""
  echo "${YELLOW}Length: ${#subject_line} characters${NC}"
  echo ""
  echo "${YELLOW}Proceeding anyway, but please consider shortening it in future commits.${NC}"
  echo ""
fi

exit 0
