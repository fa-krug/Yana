# Example docker-compose configuration for Yana
# Copy this file to docker-compose.yml and customize as needed

services:
  yana:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: yana
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      # ============================================
      # REQUIRED Configuration
      # ============================================
      
      # Server Configuration
      - NODE_ENV=production
      - PORT=3000
      
      # Database - SQLite file location
      - DATABASE_URL=/app/data/db.sqlite3
      
      # Session Secret - MUST be changed in production!
      # Generate a secure random string: openssl rand -hex 32
      - SESSION_SECRET=${SESSION_SECRET:-change-this-in-production}
      
      # ============================================
      # Optional Configuration
      # ============================================
      
      # Scheduler - Cron expression for feed aggregation
      # Default: every 30 minutes
      - AGGREGATION_SCHEDULE=${AGGREGATION_SCHEDULE:-*/30 * * * *}
      - SCHEDULER_ENABLED=${SCHEDULER_ENABLED:-true}
      
      # Worker Pool - Number of parallel workers
      - WORKER_COUNT=${WORKER_COUNT:-4}
      - WORKER_POOL_ENABLED=${WORKER_POOL_ENABLED:-true}
      
      # Base URL - Used for RSS feed generation
      # Should match your public domain
      - BASE_URL=${BASE_URL:-http://localhost:3000}
      
      # Logging Level: debug, info, warn, error
      - LOG_LEVEL=${LOG_LEVEL:-info}
      
      # Icon Cache Directory
      - ICON_CACHE_DIR=${ICON_CACHE_DIR:-/app/cache/icons}
      
      # ============================================
      # First Run: Create Superuser
      # ============================================
      # Uncomment and set these to create an admin user on first run
      # - DJANGO_SUPERUSER_USERNAME=admin
      # - DJANGO_SUPERUSER_EMAIL=admin@example.com
      # - DJANGO_SUPERUSER_PASSWORD=secure-password-here
      
    volumes:
      # Persist database and application data
      - ./data:/app/data
      
      # Optional: Persist icon cache (speeds up subsequent runs)
      - ./cache:/app/cache
      
      # Optional: Mount custom configuration
      # - ./config:/app/config:ro
      
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Resource limits (optional, adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    networks:
      - yana-network

networks:
  yana-network:
    driver: bridge

# ============================================
# Usage Examples
# ============================================
#
# 1. Basic usage:
#    docker-compose up -d
#
# 2. With environment file:
#    docker-compose --env-file .env up -d
#
# 3. View logs:
#    docker-compose logs -f yana
#
# 4. Stop:
#    docker-compose down
#
# 5. Rebuild after code changes:
#    docker-compose up -d --build
#
# 6. Access the application:
#    http://localhost:3000
#
# ============================================
# Environment Variables
# ============================================
#
# Create a .env file in the same directory:
#
# SESSION_SECRET=your-secure-random-string-here
# BASE_URL=https://your-domain.com
# WORKER_COUNT=4
# AGGREGATION_SCHEDULE=*/30 * * * *
# LOG_LEVEL=info
#
# Optional for first run:
# DJANGO_SUPERUSER_USERNAME=admin
# DJANGO_SUPERUSER_EMAIL=admin@example.com
# DJANGO_SUPERUSER_PASSWORD=secure-password
#
# ============================================
# Data Persistence
# ============================================
#
# The ./data directory will contain:
# - db.sqlite3 - Your database
# - db.sqlite3-shm - SQLite shared memory
# - db.sqlite3-wal - SQLite write-ahead log
#
# The ./cache directory will contain:
# - icons/ - Cached feed icons
#
# Make sure to backup the ./data directory regularly!
#
# ============================================
# Production Deployment
# ============================================
#
# For production, consider:
# 1. Using docker-compose.production.yml
# 2. Setting up a reverse proxy (Nginx/Traefik)
# 3. Using SSL/TLS certificates
# 4. Setting up automated backups
# 5. Monitoring and logging
# 6. Resource limits and scaling

