---
description: Testing patterns and examples
globs: ["**/*.test.ts", "**/*.spec.ts", "**/__tests__/**/*.ts"]
alwaysApply: false
---

# Testing Patterns

## Running Tests

```bash
# Run all tests
npm test

# Run tests in watch mode
npm run test:watch

# Run with coverage
npm run test:coverage
```

## Test Structure

Reference: `src/server/aggregators/__tests__/aggregator.test.ts`

```typescript
import { describe, it, expect, beforeEach } from "vitest";
import { db } from "../../db";

describe("FeedService", () => {
  beforeEach(async () => {
    // Set up test data
    await db.feed.create({
      data: {
        name: "Test Feed",
        url: "https://example.com/feed.xml",
        aggregator: "full_website",
      },
    });
  });

  it("should create a feed with valid data", async () => {
    const feed = await db.feed.findFirst({
      where: { name: "Test Feed" },
    });
    expect(feed).toBeDefined();
    expect(feed?.name).toBe("Test Feed");
  });
});
```

## Testing API Routes with Authentication

```typescript
import { describe, it, expect, beforeEach } from "vitest";
import { createTestUser, createTestFeed } from "../test-utils";

describe("FeedRouter", () => {
  let user: User;
  let feed: Feed;

  beforeEach(async () => {
    user = await createTestUser("testuser", "testpass");
    feed = await createTestFeed({
      name: "Test Feed",
      url: "https://example.com/feed.xml",
      userId: user.id,
    });
  });

  it("should require authentication", async () => {
    const caller = appRouter.createCaller({ user: null });
    await expect(
      caller.feed.getById({ feedId: feed.id })
    ).rejects.toThrow("UNAUTHORIZED");
  });

  it("should enforce user isolation", async () => {
    const otherUser = await createTestUser("other", "pass");
    const otherFeed = await createTestFeed({
      name: "Other Feed",
      url: "https://other.com/feed.xml",
      userId: otherUser.id,
    });

    const caller = appRouter.createCaller({ user });
    await expect(
      caller.feed.getById({ feedId: otherFeed.id })
    ).rejects.toThrow("FORBIDDEN");
  });
});
```

## Mocking External Services

```typescript
import { describe, it, expect, vi } from "vitest";
import { fetchFeed } from "../aggregators/base/fetch";

describe("Aggregator", () => {
  it("should fetch RSS feed", async () => {
    const mockParse = vi.fn().mockResolvedValue({
      bozo: false,
      entries: [{ title: "Test Entry", link: "https://example.com/1" }],
    });

    vi.mock("rss-parser", () => ({
      default: vi.fn().mockImplementation(() => ({
        parseURL: mockParse,
      })),
    }));

    const result = await fetchFeed("https://example.com/feed.xml");
    expect(mockParse).toHaveBeenCalledOnce();
    expect(result.entries).toHaveLength(1);
  });
});
```

## Testing HTML Content

```typescript
import { describe, it, expect } from "vitest";
import { sanitizeHtml } from "../aggregators/base/utils";

describe("sanitizeHtml", () => {
  it("should remove dangerous elements", () => {
    const html = '<p>Hello</p><script>alert("xss")</script>';
    const sanitized = sanitizeHtml(html);

    expect(sanitized).toContain("<p>Hello</p>");
    expect(sanitized).not.toContain("<script>");
  });
});
```

## Important Notes

- **Playwright won't work** in test environment. Mock it or use `fetch`.
- Always use type annotations on test functions
- Clean up test data in `afterEach()` if needed
- Test both success and error paths
