---
description: Project overview and architecture for Yana RSS aggregator
globs: ["**/*.ts", "**/*.html", "**/*.js"]
alwaysApply: false
---

# Aggregato Project Overview

Node.js/TypeScript-based RSS feed aggregator that fetches **full article content** (not just headlines) using Playwright for browser automation.

## Design Principles

### SOLID Principles

Follow SOLID design principles throughout the codebase:

- **Single Responsibility**: Each class/function has one well-defined purpose
- **Open/Closed**: Extend functionality via inheritance/composition, not modification
- **Liskov Substitution**: Subtypes must be substitutable for base types (e.g., all aggregators work with BaseAggregator interface)
- **Interface Segregation**: Prefer focused interfaces (BaseAggregator uses mixins: FetchMixin, ExtractMixin, ProcessMixin, OptionsMixin)
- **Dependency Inversion**: Depend on abstractions (aggregator plugin system uses base classes, services use dependency injection)

### KISS (Keep It Simple, Stupid)

- **Favor simplicity over cleverness**: Write clear, readable code
- **Avoid over-engineering**: Don't add features/abstraction until needed
- **Be explicit**: Prefer explicit code over implicit magic
- **Minimize dependencies**: Use Node.js built-in features when possible

### Fat Services, Thin Routes

Business logic lives in **service classes** (`src/server/services/`), not in routes or controllers:

**Good - Service layer:**
```typescript
// src/server/services/feed.service.ts
export class FeedService {
  async reloadFeed(feedId: string): Promise<{ count: number; errors: string[] }> {
    // All aggregation logic here
    const aggregator = this.getFeedAggregator(feed);
    return await aggregator.aggregate();
  }
}

// src/server/trpc/routers/feed.router.ts
export const feedRouter = router({
  reload: publicProcedure
    .input(z.object({ feedId: z.string() }))
    .mutation(async ({ input }) => {
      const feedService = new FeedService();
      return await feedService.reloadFeed(input.feedId);
    }),
});
```

**Bad - Logic in routes:**
```typescript
// DON'T do this - logic in route
export const feedRouter = router({
  reload: publicProcedure
    .input(z.object({ feedId: z.string() }))
    .mutation(async ({ input }) => {
      const feed = await db.feed.findUnique({ where: { id: input.feedId } });
      const aggregator = getAggregatorById(feed.aggregator);
      const result = await aggregator.aggregate(); // Business logic in route!
      return { count: result.count };
    }),
});
```

**Service Layer Benefits:**
- Testable in isolation
- Reusable across views, APIs, CLI commands, and tasks
- Clear separation of concerns
- Easier to maintain and refactor

## Core Data Flow

1. **Feed** model stores RSS source URL and aggregator ID
2. **Aggregator** plugin fetches RSS → extracts full content via Playwright → creates **Article** records
3. **RSS Feed** (`src/server/services/feed.service.ts`) serves articles as RSS 2.0 at `/feeds/<feed_id>/`

## Key Modules

| Module | Purpose |
|--------|---------|
| `src/server/aggregators/base/` | BaseAggregator class with mixins (fetch, extract, process, options) |
| `src/server/aggregators/*.ts` | Individual aggregator plugins (auto-discovered) |
| `src/server/db/schema.ts` | Database schema definitions (Feed, Article, etc.) |
| `src/server/services/` | Business logic services (feed, article, aggregation, icon, discovery) |
| `src/server/services/feed.service.ts` | RSS feed generation service |
| `src/server/trpc/routers/` | tRPC API routers with type-safe endpoints |
| `src/server/aggregators/reddit.ts` | Reddit aggregation logic (creates Article records from subreddit posts) |
| `src/server/aggregators/youtube.ts` | YouTube aggregation logic (creates Article records from channel videos) |

## Project Structure

```
yana/
├── src/
│   ├── server/              # Node.js/TypeScript backend
│   │   ├── aggregators/     # Aggregator plugins (auto-discovered)
│   │   │   ├── base/        # BaseAggregator framework with mixins
│   │   │   ├── heise.ts     # Example: Heise.de aggregator
│   │   │   ├── reddit.ts    # Reddit subreddit aggregator
│   │   │   ├── youtube.ts   # YouTube channel aggregator
│   │   │   ├── podcast.ts   # Podcast RSS aggregator
│   │   │   └── full_website.ts # Generic full-content aggregator
│   │   ├── services/        # Business logic layer
│   │   │   ├── feed.service.ts           # Feed operations
│   │   │   ├── article.service.ts         # Article operations
│   │   │   ├── aggregation.service.ts     # Aggregation orchestration
│   │   │   ├── icon.service.ts           # Icon/favicon fetching
│   │   │   └── feed-discovery.service.ts # RSS feed discovery
│   │   ├── trpc/            # tRPC API routers
│   │   │   └── routers/     # Type-safe API endpoints
│   │   ├── db/              # Database schema and migrations
│   │   └── scripts/         # Utility scripts
│   └── client/              # Angular frontend
├── .cursor/                 # Development documentation
│   ├── rules/               # Coding guidelines and patterns
│   └── hooks/               # Pre-commit validation
└── package.json             # Node.js dependencies
```

## User Access Control

- **Regular users**: See own feeds/subreddits + shared content (`user=NULL`)
- **Shared content** (`user=NULL`): Visible to all users
- **Superusers**: See ALL content from all users

Query pattern for user filtering:
```typescript
// Regular users
await db.feed.findMany({
  where: {
    OR: [
      { userId: user.id },
      { userId: null }, // Shared content
    ],
  },
});

// Admin users - no filtering
await db.feed.findMany();
```

## Environment Configuration

All settings via environment variables. Key vars:
- `DATABASE_URL`, `NODE_ENV`, `PORT`
- `AGGREGATION_SCHEDULE` (cron format for scheduled tasks)
- `REDDIT_CLIENT_ID`, `REDDIT_CLIENT_SECRET` (for Reddit integration)

New env vars: add to `.env.example` + README table.
