---
description: Django patterns for models, views, and admin
globs: ["**/models.py", "**/views.py", "**/admin.py", "**/migrations/*.py"]
alwaysApply: false
---

# Django Patterns

## Service Layer (Fat Services Pattern)

**CRITICAL**: Business logic must live in service classes, NOT in models or views.

### Structure

```
app/
├── models.py       # Data models only (no business logic)
├── services/       # Business logic layer
│   ├── __init__.py
│   ├── base.py     # Base service class (optional)
│   └── foo_service.py
├── views.py        # Thin views (call services)
└── admin.py        # Admin interface (call services)
```

### Service Class Pattern

```python
# core/services/feed_service.py
from typing import Any
from django.db import transaction
from core.models import Feed, Article

class FeedService:
    """Business logic for feed operations."""

    def reload_feed(self, feed: Feed) -> tuple[int, list[str]]:
        """
        Reload a feed by fetching new articles.

        Args:
            feed: The feed to reload

        Returns:
            Tuple of (article_count, error_messages)
        """
        aggregator_class = self.get_feed_aggregator_class(feed)
        aggregator = aggregator_class(feed)

        with transaction.atomic():
            article_count, errors = aggregator.aggregate()

        return article_count, errors

    def get_feed_aggregator_class(self, feed: Feed) -> type:
        """Get the aggregator class for this feed."""
        from aggregators import get_aggregator_by_id

        metadata = get_aggregator_by_id(feed.aggregator)
        if not metadata:
            raise ValueError(f"Aggregator '{feed.aggregator}' not found")
        return metadata.cls
```

### Using Services in Views

```python
# core/views.py
from django.http import JsonResponse
from core.services.feed_service import FeedService

def reload_feed(request, feed_id):
    """Reload a specific feed."""
    feed = get_object_or_404(Feed, pk=feed_id)
    feed_service = FeedService()
    count, errors = feed_service.reload_feed(feed)

    return JsonResponse({
        "count": count,
        "errors": errors,
    })
```

### Using Services in Admin Actions

```python
# core/admin.py
from core.services.feed_service import FeedService

@admin.action(description="Reload selected feeds")
def reload_feeds(self, request, queryset):
    feed_service = FeedService()
    for feed in queryset:
        feed_service.reload_feed(feed)
```

### Using Services in Management Commands

```python
# core/management/commands/reload_feeds.py
from django.core.management.base import BaseCommand
from core.services.feed_service import FeedService

class Command(BaseCommand):
    def handle(self, *args, **options):
        feed_service = FeedService()
        for feed in Feed.objects.filter(enabled=True):
            count, errors = feed_service.reload_feed(feed)
            self.stdout.write(f"Loaded {count} articles from {feed.name}")
```

### Benefits

- **Testable**: Services can be tested in isolation
- **Reusable**: Same logic works in views, admin, API, CLI, tasks
- **Maintainable**: Business logic in one place
- **Clear separation**: Models = data, Services = logic, Views = presentation

## Models

Reference: `core/models.py`

### Feed Model

```python
class Feed(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, null=True, blank=True, ...)
    name = models.CharField(max_length=255)
    url = models.URLField(max_length=500)
    aggregator = models.CharField(max_length=255, default="full_website")
    enabled = models.BooleanField(default=True)
    aggregator_options = models.JSONField(default=dict, blank=True)
    groups = models.ManyToManyField("api.Group", related_name="feeds", blank=True)
```

### Article Model

```python
class Article(models.Model):
    feed = models.ForeignKey(Feed, on_delete=models.CASCADE, related_name="articles")
    name = models.CharField(max_length=500)
    url = models.URLField(max_length=1000, unique=True)
    date = models.DateTimeField(default=timezone.now)
    content = models.TextField()
```

## Migrations

Always check before committing:

```bash
python manage.py makemigrations --check  # Verify no missing migrations
python manage.py migrate                  # Apply migrations
```

## User Ownership Pattern

For user-owned content with shared fallback:

```python
# Model
class Feed(models.Model):
    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        help_text="User who owns this (None = shared, visible to all)",
    )

# View/Admin queryset filtering
def get_queryset(self):
    qs = super().get_queryset()
    if self.request.user.is_superuser:
        return qs
    return qs.filter(Q(user=self.request.user) | Q(user__isnull=True))
```

## Admin Customization

Reference: `core/admin.py`

```python
@admin.register(Feed)
class FeedAdmin(admin.ModelAdmin):
    list_display = ["name", "url", "aggregator", "enabled", "user"]
    list_filter = ["enabled", "aggregator", "user"]
    search_fields = ["name", "url"]
    actions = ["run_aggregation"]

    @admin.action(description="Run aggregation for selected feeds")
    def run_aggregation(self, request, queryset):
        for feed in queryset:
            # Queue aggregation task
            pass
```

## Views with Authentication

RSS feeds support session auth and HTTP Basic Auth:

```python
from django.contrib.auth import authenticate

def feed_view(request, feed_id):
    # Try session auth first
    if request.user.is_authenticated:
        return render_feed(request.user, feed_id)

    # Try HTTP Basic Auth
    auth = request.META.get("HTTP_AUTHORIZATION", "")
    if auth.startswith("Basic "):
        credentials = base64.b64decode(auth[6:]).decode()
        username, password = credentials.split(":", 1)
        user = authenticate(username=username, password=password)
        if user:
            return render_feed(user, feed_id)

    # Unauthorized
    response = HttpResponse(status=401)
    response["WWW-Authenticate"] = 'Basic realm="Aggregato"'
    return response
```
