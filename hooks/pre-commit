#!/bin/bash
# Git pre-commit hook that runs formatting and tests
# This hook runs before git commits are created

# Get the git repository root directory
GIT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || pwd)
cd "$GIT_ROOT" || exit 1

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”’ PRE-COMMIT VALIDATION - MANDATORY CODE QUALITY CHECKS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "âš ï¸  IMPORTANT: All checks must pass. Failures will BLOCK your commit."
echo "ğŸš« Bypassing this hook is NOT allowed - code quality is mandatory."
echo ""
echo "ğŸ” Running validation checks..."
echo ""

# Step 1: Check if Node.js dependencies are installed
echo "ğŸ“¦ Checking Node.js dependencies..."
if [ ! -d "$GIT_ROOT/node_modules" ]; then
    echo "âš ï¸  node_modules not found. Installing dependencies..."
    cd "$GIT_ROOT" || exit 1
    npm install --silent 2>&1 || {
        echo "âŒ Failed to install dependencies!"
        exit 1
    }
    echo "âœ… Dependencies installed!"
fi

# Step 2: Run Prettier formatting check
echo "ğŸ’… Running Prettier formatting check..."
cd "$GIT_ROOT" || exit 1
if npm run format:check 2>&1; then
    echo "âœ… Prettier check passed!"
else
    echo "âš ï¸  Prettier check failed, attempting to auto-fix..."
    if npm run format 2>&1; then
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âš ï¸  PRETTIER AUTO-FORMATTED FILES"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "âœ… Files have been auto-formatted, but commit is BLOCKED."
        echo ""
        echo "ğŸ“ Action required:"
        echo "   1. Review the formatted changes"
        echo "   2. Stage the formatted files: git add ."
        echo "   3. Commit again"
        echo ""
        echo "ğŸš« DO NOT bypass this hook - review formatting changes before committing."
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        exit 1
    else
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸš¨ PRE-COMMIT HOOK FAILED: PRETTIER FORMATTING ERRORS DETECTED"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "âŒ CRITICAL: Code formatting check failed!"
        echo ""
        echo "âš ï¸  COMMIT BLOCKED - This is a blocking issue that MUST be fixed immediately."
        echo ""
        echo "ğŸ“ Action required:"
        echo "   1. Review the Prettier errors above"
        echo "   2. Run 'npm run format' to auto-format"
        echo "   3. Review the changes and commit again"
        echo ""
        echo "ğŸš« DO NOT bypass this hook with --no-verify - code formatting is mandatory."
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        exit 1
    fi
fi
echo ""

# Step 3: Run tests
echo "ğŸ§ª Running test suite..."
cd "$GIT_ROOT" || exit 1
if npm test 2>&1; then
    echo ""
    echo "âœ… All tests passed!"
else
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸš¨ PRE-COMMIT HOOK FAILED: TESTS FAILED"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "âŒ CRITICAL: Test suite failed - broken code detected!"
    echo ""
    echo "âš ï¸  COMMIT BLOCKED - This is a SERIOUS issue that MUST be fixed immediately."
    echo ""
    echo "ğŸ“ Action required:"
    echo "   1. Review the test failures above"
    echo "   2. Fix all failing tests"
    echo "   3. Run tests manually: npm test"
    echo "   4. Ensure all tests pass before committing"
    echo ""
    echo "ğŸš« DO NOT bypass this hook with --no-verify - broken tests break the build!"
    echo ""
    echo "ğŸ’¡ Remember: Tests are mandatory. No exceptions."
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    exit 1
fi
echo ""

echo ""
echo "ğŸ‰ All validation checks passed! Proceeding with commit..."
echo ""

exit 0
